<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Administrador de Tareas</title>
    <!-- Incluir Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container my-5">
        <div class="row">
            <!-- Bloque de Tareas Programadas -->
            <div class="col-lg-6 tasks border border-secondary bg-light rounded p-3">
                <h3 class="text-center mb-4">Tareas Programadas</h3>

                <!-- Formulario de Tareas -->
                <form id="task-form">
                    <input type="hidden" id="task_id" name="task_id">
                    <div class="mb-3">
                        <label for="name" class="form-label">Nombre de la Tarea</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="script" class="form-label">Ruta del Script</label>
                        <input type="text" class="form-control" id="script" name="script" required>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="days" class="form-label">Días</label>
                            <input type="number" class="form-control" id="days" name="days" min="0" value="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="hours" class="form-label">Horas</label>
                            <input type="number" class="form-control" id="hours" name="hours" min="0" value="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="minutes" class="form-label">Minutos</label>
                            <input type="number" class="form-control" id="minutes" name="minutes" min="0" value="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="seconds" class="form-label">Segundos</label>
                            <input type="number" class="form-control" id="seconds" name="seconds" min="0" value="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="start_date" class="form-label">Fecha de Inicio</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="start_time" class="form-label">Hora de Inicio</label>
                        <input type="time" class="form-control" id="start_time" name="start_time" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Guardar Tarea</button>
                </form>

                <!-- Lista de Tareas -->
                <div class="task-list mt-4">
                    <h4 class="text-center mb-3">Lista de Tareas</h4>
                    <div class="table-responsive" style="max-height: 40vh; overflow-y: auto;">
                        <table class="table table-bordered table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Periodicidad</th>
                                    <th>Inicio</th>
                                    <th>Activo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Las filas de tareas se agregarán dinámicamente aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bloque de Registro de Log -->
            <div class="col-lg-6 log border border-secondary bg-white rounded p-3">
                <h3 class="text-center mb-4">Registro de Log</h3>

                <!-- Formulario de Filtrado -->
                <form id="log-filter-form" class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label for="logTaskName" class="form-label">Nombre de la Tarea</label>
                        <input type="text" class="form-control" id="logTaskName" placeholder="Buscar por nombre">
                    </div>
                    <div class="col-md-4">
                        <label for="logStatusFilter" class="form-label">Estado</label>
                        <select id="logStatusFilter" class="form-select">
                            <option value="">Todos</option>
                            <option value="success">Éxito</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="logStartDateFilter" class="form-label">Fecha de Inicio Desde</label>
                        <input type="date" class="form-control" id="logStartDateFilter">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                    </div>
                </form>

                <!-- Tabla para mostrar los logs -->
                <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Nombre de la Tarea</th>
                                <th>Fecha y Hora de Inicio</th>
                                <th>Hora de Fin</th>
                                <th>Estado</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody">
                            <!-- Las filas de logs se agregarán dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>

                <!-- Botón para actualizar los logs -->
                <div class="d-grid mt-3">
                    <button id="refreshLogsBtn" class="btn btn-secondary">Actualizar Logs</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación para Eliminar Tarea -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            ¿Estás seguro de que deseas eliminar esta tarea?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <!-- Los toasts se agregarán dinámicamente aquí -->
    </div>

    <!-- Incluir Bootstrap JS y sus dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Tu Código JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Variables y elementos del DOM
            const taskForm = document.getElementById("task-form");
            const toastContainer = document.querySelector(".toast-container");
            const logTableBody = document.getElementById("logTableBody"); // Tabla de logs
            const taskTableBody = document.querySelector(".task-list tbody"); // Tabla de tareas

            // Elementos para el filtrado de logs
            const logFilterForm = document.getElementById("log-filter-form");
            const logTaskNameInput = document.getElementById("logTaskName");
            const logStatusFilter = document.getElementById("logStatusFilter");
            const logStartDateFilter = document.getElementById("logStartDateFilter");
            const refreshLogsBtn = document.getElementById("refreshLogsBtn");

            // Establecer la fecha y hora actuales en los campos correspondientes del formulario de tareas
            const startDateInput = document.getElementById("start_date");
            const startTimeInput = document.getElementById("start_time");

            // Obtener la fecha y hora actuales
            const now = new Date();
            const timezoneOffset = now.getTimezoneOffset() * 60000; // Offset en milisegundos
            const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, -1);

            // Formatear la fecha y hora para los inputs
            const currentDate = localISOTime.split("T")[0]; // YYYY-MM-DD
            const currentTime = localISOTime.split("T")[1].slice(0, 5); // HH:MM

            // Establecer los valores por defecto en el formulario de tareas
            startDateInput.value = currentDate;
            startTimeInput.value = currentTime;

            // Variable para almacenar el ID de la tarea a eliminar
            let taskIdToDelete = null;

            // ------------------ Funcionalidad de Tareas ------------------

            taskForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                console.log("Evento submit capturado");

                const formData = new FormData(taskForm);
                const data = {
                    name: formData.get("name"),
                    script: formData.get("script"),
                    days: parseInt(formData.get("days")) || 0,
                    hours: parseInt(formData.get("hours")) || 0,
                    minutes: parseInt(formData.get("minutes")) || 0,
                    seconds: parseInt(formData.get("seconds")) || 0,
                    start_date: formData.get("start_date"),
                    start_time: formData.get("start_time"),
                    active: true, // Por defecto, siempre activo
                    task_id: formData.get("task_id") ? parseInt(formData.get("task_id")) : null,
                };

                try {
                    const response = await fetch("/add-task", {
                        method: "POST",
                        body: JSON.stringify(data),
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showToast(result.message || "Tarea guardada correctamente.", "success");
                        loadTasks(); // Actualizar lista de tareas
                        taskForm.reset();
                        document.getElementById("task_id").value = "";

                        // Restablecer la fecha y hora actuales después de resetear el formulario
                        startDateInput.value = currentDate;
                        startTimeInput.value = currentTime;
                    } else {
                        showToast(result.detail || "Error al guardar la tarea.", "danger");
                    }
                } catch (error) {
                    showToast("Error al conectar con el servidor.", "danger");
                    console.error(error); // Para depuración
                }
            });

            // Función para cargar los datos de una tarea en el formulario
            function loadTaskInForm(task) {
                document.getElementById("task_id").value = task.id || "";
                document.getElementById("name").value = task.name;
                document.getElementById("script").value = task.script_path;

                const periodicity = task.periodicity;
                document.getElementById("days").value = periodicity.days || 0;
                document.getElementById("hours").value = periodicity.hours || 0;
                document.getElementById("minutes").value = periodicity.minutes || 0;
                document.getElementById("seconds").value = periodicity.seconds || 0;

                document.getElementById("start_date").value = task.start_date || currentDate;
                document.getElementById("start_time").value = task.start_time || currentTime;

                // El campo "active" ya no existe en el formulario
            }

            // Función para mostrar notificaciones (toasts)
            function showToast(message, type = "info") {
                const toastEl = document.createElement("div");
                toastEl.className = `toast align-items-center text-bg-${type} border-0`;
                toastEl.role = "alert";
                toastEl.ariaLive = "assertive";
                toastEl.ariaAtomic = "true";
                toastEl.style.width = "100%"; // Ancho completo

                const toastBody = document.createElement("div");
                toastBody.className = "d-flex";
                toastBody.innerHTML = `
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                `;
                toastEl.appendChild(toastBody);

                toastContainer.appendChild(toastEl);

                const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
                toast.show();

                // Remover el toast después de que se cierre
                toastEl.addEventListener('hidden.bs.toast', () => {
                    toastEl.remove();
                });
            }

            // Función para cargar la lista de tareas
            async function loadTasks() {
                try {
                    const response = await fetch("/get-tasks");
                    if (!response.ok) {
                        throw new Error(`Error: ${response.status} ${response.statusText}`);
                    }
                    const tasks = await response.json();

                    taskTableBody.innerHTML = "";

                    tasks.forEach(task => {
                        const row = document.createElement("tr");
                        const periodicity = task.periodicity;
                        const formattedPeriodicity = `${periodicity.days}d ${periodicity.hours}h ${periodicity.minutes}m ${periodicity.seconds}s`;

                        const startDateTime = `${task.start_date} ${task.start_time}`;

                        row.innerHTML = `
                            <td>${task.id}</td>
                            <td>${task.name}</td>
                            <td>${formattedPeriodicity}</td>
                            <td>${startDateTime}</td>
                            <td>
                                <input type="checkbox" class="form-check-input task-checkbox" ${task.is_active ? "checked" : ""}
                                       data-task-id="${task.id}">
                            </td>
                            <td>
                                <button class="btn btn-danger btn-sm delete-task-btn" data-task-id="${task.id}">
                                    Eliminar
                                </button>
                            </td>
                        `;
                        taskTableBody.appendChild(row);

                        // Manejar el clic en la fila para cargar los datos en el formulario
                        row.addEventListener("click", (event) => {
                            if (event.target.tagName === "INPUT" || event.target.classList.contains("delete-task-btn")) return;
                            loadTaskInForm(task);
                        });

                        // Evento para el checkbox de activar/desactivar
                        const checkbox = row.querySelector(".task-checkbox");
                        checkbox.addEventListener("change", async (event) => {
                            const taskId = event.target.dataset.taskId;
                            const isActive = event.target.checked;
                            try {
                                const response = await fetch(`/tasks/${taskId}/toggle`, {
                                    method: "POST",
                                    body: JSON.stringify({ is_active: isActive }),
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                });
                                const result = await response.json();
                                if (response.ok) {
                                    showToast(result.message || "Tarea actualizada correctamente.", "success");
                                } else {
                                    showToast(result.detail || "Error al actualizar la tarea.", "danger");
                                }
                            } catch (error) {
                                showToast("Error al conectar con el servidor.", "danger");
                                console.error(error);
                            }
                        });

                        // Evento para el botón "Eliminar"
                        const deleteButton = row.querySelector(".delete-task-btn");
                        deleteButton.addEventListener("click", (event) => {
                            event.stopPropagation();
                            taskIdToDelete = event.target.dataset.taskId;

                            // Mostrar el modal de confirmación
                            const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
                            confirmDeleteModal.show();
                        });
                    });
                } catch (error) {
                    showToast("Error al cargar las tareas.", "danger");
                    console.error(error);
                }
            }

            // Manejar la confirmación en el modal
            const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
            confirmDeleteBtn.addEventListener("click", async () => {
                if (!taskIdToDelete) return;
                try {
                    const response = await fetch(`/tasks/${taskIdToDelete}`, {
                        method: "DELETE",
                    });
                    if (response.ok) {
                        showToast("Tarea eliminada correctamente.", "success");
                        loadTasks();
                    } else {
                        showToast("Error al eliminar la tarea.", "danger");
                    }
                } catch (error) {
                    showToast("Error al conectar con el servidor.", "danger");
                    console.error(error);
                } finally {
                    taskIdToDelete = null;
                    const confirmDeleteModal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
                    confirmDeleteModal.hide();
                }
            });

            // Función para formatear la fecha a YYMMDD
            function formatDateToYYMMDD(dateInput) {
                const date = new Date(dateInput);
                if (isNaN(date.getTime())) {
                    return null;
                }
                const yy = date.getFullYear().toString().slice(-2);
                const mm = (date.getMonth() + 1).toString().padStart(2, '0');
                const dd = date.getDate().toString().padStart(2, '0');
                return `${yy}${mm}${dd}`;
            }

            // ------------------ Funcionalidad de Logs ------------------

            // Función para obtener y mostrar los logs
            async function fetchLogs(filters = {}) {
                try {
                    // Validar los filtros antes de enviar
                    if (filters.start_date) {
                        const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                        if (!datePattern.test(filters.start_date)) {
                            throw new Error("El formato de la fecha de inicio es inválido. Usa YYYY-MM-DD.");
                        }
                    }

                    if (filters.status && !["success", "error"].includes(filters.status.toLowerCase())) {
                        throw new Error("El estado debe ser 'success' o 'error'.");
                    }

                    // Construir la URL con parámetros de consulta
                    const params = new URLSearchParams(filters);
                    const response = await fetch(`/get-logs?${params.toString()}`);
                    if (!response.ok) {
                        throw new Error(`Error: ${response.status} ${response.statusText}`);
                    }
                    const logs = await response.json();

                    // Limpiar la tabla
                    logTableBody.innerHTML = "";

                    logs.forEach(log => {
                        const row = document.createElement("tr");

                        // Crear celdas
                        const nameCell = document.createElement("td");
                        nameCell.textContent = log.task_name;

                        const startCell = document.createElement("td");
                        startCell.textContent = log.start_datetime;

                        const endCell = document.createElement("td");
                        endCell.textContent = log.end_time;

                        const statusCell = document.createElement("td");
                        if (log.status.toLowerCase().startsWith('error')) {
                            statusCell.innerHTML = `<span class="badge bg-danger">Error</span>`;
                        } else if (log.status.toLowerCase().startsWith('success')) {
                            statusCell.innerHTML = `<span class="badge bg-success">Éxito</span>`;
                        } else {
                            statusCell.textContent = log.status;
                        }

                        const actionCell = document.createElement("td");
                        actionCell.textContent = log.action || '-';

                        // Agregar celdas a la fila
                        row.appendChild(nameCell);
                        row.appendChild(startCell);
                        row.appendChild(endCell);
                        row.appendChild(statusCell);
                        row.appendChild(actionCell);

                        // Agregar fila a la tabla
                        logTableBody.appendChild(row);
                    });
                } catch (error) {
                    console.error("Error al obtener los logs:", error);
                    showToast(error.message || "Hubo un problema al obtener el historial de logs.", "danger");
                }
            }

            // Manejar el envío del formulario de filtros
            logFilterForm.addEventListener("submit", (event) => {
                event.preventDefault();
                const taskName = logTaskNameInput.value.trim();
                const status = logStatusFilter.value;
                const startDate = logStartDateFilter.value;

                const filters = {};

                if (taskName) {
                    filters.task_name = taskName;
                }
                if (status) {
                    filters.status = status;
                }
                if (startDate) {
                    filters.start_date = startDate;
                }

                fetchLogs(filters);
            });

            // Manejar el clic en el botón de actualizar logs
            refreshLogsBtn.addEventListener("click", () => {
                // Resetear los filtros
                logFilterForm.reset();
                fetchLogs();
            });

            // Cargar los logs al cargar la página sin filtros
            fetchLogs();

            // Cargar las tareas al cargar la página
            loadTasks();
        });
    </script>
</body>
</html>
