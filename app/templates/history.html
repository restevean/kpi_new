<!-- app/templates/history.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historial de Logs</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .log-container {
            max-height: 80vh;
            overflow-y: auto;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4">Historial de Logs</h2>
        <div class="mb-3">
            <label for="logDate" class="form-label">Seleccionar Fecha:</label>
            <input type="date" id="logDate" class="form-control" />
        </div>
        <button id="fetchLogBtn" class="btn btn-primary mb-4">Obtener Log</button>
        <div class="log-container">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Nombre de la Tarea</th>
                        <th>Fecha y Hora de Inicio</th>
                        <th>Hora de Fin</th>
                        <th>Estado</th>
                        <th>Acción</th> <!-- Nueva columna para la acción -->
                    </tr>
                </thead>
                <tbody id="logTableBody">
                    <!-- Las filas del log se generarán aquí -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Contenedor para Toasts de Notificación -->
    <div class="toast-container"></div>

    <!-- Bootstrap JS y dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
        const logDateInput = document.getElementById("logDate");
        const logTableBody = document.getElementById("logTableBody");

        // Preseleccionar la fecha actual
        const today = new Date().toISOString().split("T")[0];
        logDateInput.value = today;

        // Función para formatear fecha a YYMMDD
        function formatDateToYYMMDD(dateInput) {
            const date = new Date(dateInput);
            if (isNaN(date.getTime())) return null;
            const yy = date.getFullYear().toString().slice(-2);
            const mm = (date.getMonth() + 1).toString().padStart(2, '0');
            const dd = date.getDate().toString().padStart(2, '0');
            return `${yy}${mm}${dd}`;
        }

        // Función para mostrar notificaciones (toasts)
        function showToast(message, type = "info") {
            const toastContainer = document.querySelector(".toast-container");
            const toastEl = document.createElement("div");
            toastEl.className = `toast align-items-center text-bg-${type} border-0`;
            toastEl.role = "alert";
            toastEl.ariaLive = "assertive";
            toastEl.ariaAtomic = "true";
            toastEl.style.minWidth = "250px";

            const toastBody = document.createElement("div");
            toastBody.className = "d-flex";
            toastBody.innerHTML = `
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            `;
            toastEl.appendChild(toastBody);
            toastContainer.appendChild(toastEl);

            const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
            toast.show();

            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });
        }

        // Función para cargar y mostrar logs
        function fetchAndDisplayLogs(date) {
            if (!date) {
                showToast("Fecha inválida. Selecciona una fecha válida.", "warning");
                return;
            }

            fetch(`/get-logs?date=${date}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("No se encontraron logs para esta fecha.");
                    }
                    return response.text();
                })
                .then(data => {
                    logTableBody.innerHTML = ""; // Limpiar la tabla

                    const logs = data.trim().split("\n"); // Dividir en líneas
                    if (!logs.length || (logs.length === 1 && logs[0] === "")) {
                        throw new Error("No hay entradas de log para la fecha seleccionada.");
                    }

                    logs.forEach(log => {
                        const logParts = log.split(", ");
                        if (logParts.length === 4) {
                            const [name, start, end, status] = logParts;

                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${name}</td>
                                <td>${start}</td>
                                <td>${end}</td>
                                <td>${status}</td>
                            `;
                            logTableBody.appendChild(row);
                        } else {
                            console.warn("Formato de log inesperado:", log);
                        }
                    });

                    showToast("Logs cargados correctamente.", "success");
                })
                .catch(error => {
                    logTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${error.message}</td></tr>`;
                    console.error("Error al cargar los logs:", error);
                });
        }

        // Cargar logs al hacer clic en el botón
        document.getElementById("fetchLogBtn").addEventListener("click", () => {
            const date = formatDateToYYMMDD(logDateInput.value);
            fetchAndDisplayLogs(date);
        });

        // Cargar automáticamente el log del día actual
        const formattedToday = formatDateToYYMMDD(today);
        fetchAndDisplayLogs(formattedToday);
    });

    </script>

</body>
</html>
